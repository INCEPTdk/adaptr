<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content='Specifies the design of an adaptive trial with any type of outcome and
validates all inputs. Use run_trial() or run_trials() to conduct
single/multiple simulations of the specified trial, respectively.
See setup_trial_binom() and setup_trial_norm() for simplified setup of
trial designs common outcome types. For additional trial specification
examples, see the the Basic examples vignette
(vignette("Basic-examples", package = "adaptr")) and the
Advanced example vignette
(vignette("Advanced-example", package = "adaptr")).'><title>Setup a generic trial specification — setup_trial • adaptr</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Setup a generic trial specification — setup_trial"><meta property="og:description" content='Specifies the design of an adaptive trial with any type of outcome and
validates all inputs. Use run_trial() or run_trials() to conduct
single/multiple simulations of the specified trial, respectively.
See setup_trial_binom() and setup_trial_norm() for simplified setup of
trial designs common outcome types. For additional trial specification
examples, see the the Basic examples vignette
(vignette("Basic-examples", package = "adaptr")) and the
Advanced example vignette
(vignette("Advanced-example", package = "adaptr")).'><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">adaptr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Advanced-example.html">Advanced example</a>
    <a class="dropdown-item" href="../articles/Basic-examples.html">Basic examples</a>
    <a class="dropdown-item" href="../articles/Overview.html">Overview</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/INCEPTdk/adaptr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Setup a generic trial specification</h1>
      <small class="dont-index">Source: <a href="https://github.com/INCEPTdk/adaptr/blob/HEAD/R/setup_trial.R" class="external-link"><code>R/setup_trial.R</code></a></small>
      <div class="d-none name"><code>setup_trial.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Specifies the design of an adaptive trial with any type of outcome and
validates all inputs. Use <code><a href="run_trial.html">run_trial()</a></code> or <code><a href="run_trials.html">run_trials()</a></code> to conduct
single/multiple simulations of the specified trial, respectively.<br>
See <code><a href="setup_trial_binom.html">setup_trial_binom()</a></code> and <code><a href="setup_trial_norm.html">setup_trial_norm()</a></code> for simplified setup of
trial designs common outcome types. For additional trial specification
examples, see the the <strong>Basic examples</strong> vignette
(<code><a href="../articles/Basic-examples.html">vignette("Basic-examples", package = "adaptr")</a></code>) and the
<strong>Advanced example</strong> vignette
(<code><a href="../articles/Advanced-example.html">vignette("Advanced-example", package = "adaptr")</a></code>).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">setup_trial</span><span class="op">(</span>
  <span class="va">arms</span>,
  <span class="va">true_ys</span>,
  fun_y_gen <span class="op">=</span> <span class="cn">NULL</span>,
  fun_draws <span class="op">=</span> <span class="cn">NULL</span>,
  start_probs <span class="op">=</span> <span class="cn">NULL</span>,
  fixed_probs <span class="op">=</span> <span class="cn">NULL</span>,
  min_probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">arms</span><span class="op">)</span><span class="op">)</span>,
  max_probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">arms</span><span class="op">)</span><span class="op">)</span>,
  data_looks <span class="op">=</span> <span class="cn">NULL</span>,
  max_n <span class="op">=</span> <span class="cn">NULL</span>,
  look_after_every <span class="op">=</span> <span class="cn">NULL</span>,
  control <span class="op">=</span> <span class="cn">NULL</span>,
  control_prob_fixed <span class="op">=</span> <span class="cn">NULL</span>,
  inferiority <span class="op">=</span> <span class="fl">0.01</span>,
  superiority <span class="op">=</span> <span class="fl">0.99</span>,
  equivalence_prob <span class="op">=</span> <span class="cn">NULL</span>,
  equivalence_diff <span class="op">=</span> <span class="cn">NULL</span>,
  equivalence_only_first <span class="op">=</span> <span class="cn">NULL</span>,
  futility_prob <span class="op">=</span> <span class="cn">NULL</span>,
  futility_diff <span class="op">=</span> <span class="cn">NULL</span>,
  futility_only_first <span class="op">=</span> <span class="cn">NULL</span>,
  highest_is_best <span class="op">=</span> <span class="cn">FALSE</span>,
  soften_power <span class="op">=</span> <span class="fl">1</span>,
  fun_raw_est <span class="op">=</span> <span class="va">mean</span>,
  cri_width <span class="op">=</span> <span class="fl">0.95</span>,
  n_draws <span class="op">=</span> <span class="fl">5000</span>,
  robust <span class="op">=</span> <span class="cn">TRUE</span>,
  description <span class="op">=</span> <span class="cn">NULL</span>,
  add_info <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>arms</dt>
<dd><p>character vector with unique names for the trial arms.</p></dd>


<dt>true_ys</dt>
<dd><p>numeric vector specifying true outcomes (e.g., event
probabilities, mean values, etc.) for all trial <code>arms</code>.</p></dd>


<dt>fun_y_gen</dt>
<dd><p>function, generates outcomes. See <code>setup_trial()</code>
<strong>Details</strong>
for information on how to specify this function.<br><strong>Note:</strong> this function is called once during setup to validate the output
structure.</p></dd>


<dt>fun_draws</dt>
<dd><p>function, generates posterior draws. See <code>setup_trial()</code>
<strong>Details</strong> for information on how to specify this function.<br><strong>Note:</strong> this function is called up to three times during setup to
validate the output structure.</p></dd>


<dt>start_probs</dt>
<dd><p>numeric vector, allocation probabilities for each arm at
the beginning of the trial. The default (<code>NULL</code>) is automatically
changed to equal randomisation.</p></dd>


<dt>fixed_probs</dt>
<dd><p>numeric vector, fixed allocation probabilities for each
arm - must be either a numeric vector with <code>NA</code> for arms without fixed
probabilities and values between <code>0</code> and <code>1</code> for the other arms or <code>NULL</code>
(default), if adaptive randomisation is used for all arms or if one of the
special settings (<code>"sqrt-based"</code>, <code>"sqrt-based start"</code>,
<code>"sqrt-based fixed"</code>, or <code>"match"</code>) is specified for <code>control_prob_fixed</code>
(described below).</p></dd>


<dt>min_probs</dt>
<dd><p>numeric vector, lower threshold for adaptive allocation
probabilities, lower probabilities will be rounded up to these values. Must
be <code>NA</code> (default for all arms) if no boundary is wanted.</p></dd>


<dt>max_probs</dt>
<dd><p>numeric vector, upper threshold for adaptive allocation
probabilities, higher probabilities will be rounded down to these values.
Must be <code>NA</code> (default for all arms) if no boundary is wanted.</p></dd>


<dt>data_looks</dt>
<dd><p>vector of increasing integers, specifies when to conduct
adaptive analyses (= the total number of patients randomised at each
adaptive analysis). The last number in the vector represents the maximum
sample size. Instead of specifying <code>data_looks</code>, the <code>max_n</code> and
<code>look_after_every</code> arguments can be used in combination (then <code>data_looks</code>
must be <code>NULL</code>, the default).</p></dd>


<dt>max_n</dt>
<dd><p>single integer, maximum total sample size (defaults to <code>NULL</code>).
Must only be specified if <code>data_looks</code> is <code>NULL</code>. Requires specification of
the <code>look_after_every</code> argument.</p></dd>


<dt>look_after_every</dt>
<dd><p>single integer, specified together with <code>max_n</code>.
Adaptive analyses will be conducted after every <code>look_after_every</code>
patients randomised, and at the total sample size as specified by <code>max_n</code>
(<code>max_n</code> does not need to be a multiple of <code>look_after_every</code>). If
specified, <code>data_looks</code> must be <code>NULL</code> (as default).</p></dd>


<dt>control</dt>
<dd><p>single character string, name of one of the <code>arms</code> or <code>NULL</code>
(default). If specified, this arm will serve as a common control arm, to
which all other arms will be compared and the
inferiority/superiority/equivalence thresholds (see below) will be for
those comparisons. See <code>setup_trial()</code> <strong>Details</strong> below for information on
behaviour with respect to these comparisons.</p></dd>


<dt>control_prob_fixed</dt>
<dd><p>if a common <code>control</code> arm is specified, this must
be set to either <code>NULL</code> (the default), in which case the control arm
allocation probability will not be fixed if control arms change (the
allocation probability to the first control arm may still be fixed using
<code>fixed_probs</code>) Otherwise a vector of probabilities of either length <code>1</code> or
<code>number of arms - 1</code> can be provided, or one of the special arguments
<code>"sqrt-based"</code>, <code>"sqrt-based start"</code>, <code>"sqrt-based fixed"</code> or <code>"match"</code>.
See <code>setup_trial()</code> <strong>Details</strong> below for details in behaviour.</p></dd>


<dt>inferiority</dt>
<dd><p>single numeric (<code>&gt; 0</code> and <code>&lt;1</code>, default is <code>0.01</code>)
specifying the inferiority threshold. An arm will be considered inferior
and dropped if the probability that it is best (when comparing all arms) or
better than the control arm (when a common <code>control</code> is used) drops below
this threshold.</p></dd>


<dt>superiority</dt>
<dd><p>single numeric (<code>&gt;0</code> and <code>&lt;1</code>, default is <code>0.99</code>)
specifying the superiority threshold. If the probability that an arm is
best (when comparing all arms) or better than the control arm (when a
common <code>control</code> is used) exceeds this number, said arm will be declared
the winner and the trial will be stopped (if no common <code>control</code> is used or
if the last comparator is dropped in a design with a common control) <em>or</em>
become the new control and the trial will continue (if a common control is
specified).</p></dd>


<dt>equivalence_prob</dt>
<dd><p>single numeric (<code>&gt; 0</code> and <code>&lt; 1</code>) or <code>NULL</code> (default,
corresponding to no equivalence assessment). If a numeric value is
specified, arms will be stopped for equivalence if the probability of
either <em>(a)</em> equivalence compared to a common <code>control</code> or <em>(b)</em>
equivalence between all arms remaining (designs without a common control)
exceeds this threshold. Requires specification of <code>equivalence_diff</code>,
<code>equivalence_only_first</code>, and a common <code>control</code> arm.</p></dd>


<dt>equivalence_diff</dt>
<dd><p>single numeric value (<code>&gt; 0</code>) or <code>NULL</code> (default,
corresponding to no equivalence assessment). If a numeric value is
specified, estimated differences below this threshold will be considered
equivalent when assessing equivalence. For designs with a common <code>control</code>
arm, the differences between each non-control arm and the <code>control</code> arm is
used, and for trials without a common <code>control</code> arm, the difference between
the highest and lowest estimated outcome rates are used and the trial is
only stopped for equivalence if all remaining arms are thus equivalent.</p></dd>


<dt>equivalence_only_first</dt>
<dd><p>single logical in trial specifications where
<code>equivalence_prob</code> and <code>equivalence_diff</code> are specified, otherwise <code>NULL</code>
(default). Must be <code>NULL</code> for designs without a common control arm. If a
common <code>control</code> arm is used, this specifies whether equivalence will only
be assessed for the first control (if <code>TRUE</code>) or also for subsequent
control arms (if <code>FALSE</code>) if one arm is superior to the first control and
becomes the new control.</p></dd>


<dt>futility_prob</dt>
<dd><p>single numeric (<code>&gt; 0</code> and <code>&lt; 1</code>) or <code>NULL</code> (default,
corresponds to no futility assessment). If a numeric value is specified,
<code>arms</code> will be stopped for futility when the probability for futility
compared to the common <code>control</code> exceeds this threshold. Requires a common
<code>control</code> arm, specification of <code>futility_diff</code> and <code>futility_only_first</code>.</p></dd>


<dt>futility_diff</dt>
<dd><p>single numeric value (<code>&gt; 0</code>) or <code>NULL</code> (default,
corresponding to no futility assessment). If a numeric value is specified,
estimated differences below this threshold in the <em>beneficial</em> direction
(as specified in <code>highest_is_best</code>) will be considered futile when
assessing futility in designs with a common <code>control</code> arm. If only 1 arm
remains after dropping arms for futility, the trial will be stopped without
declaring the last arm superior.</p></dd>


<dt>futility_only_first</dt>
<dd><p>single logical in trial specifications designs
where <code>futility_prob</code> and <code>futility_diff</code> are specified, otherwise <code>NULL (default). Must be </code>NULL<code>for designs without a common</code>control<code>arm. Specifies whether futility will only be assessed against the first</code>control<code>(if</code>TRUE<code>) or also for subsequent control arms (if </code>FALSE`) if
one arm is superior to the first control and becomes the new control.</p></dd>


<dt>highest_is_best</dt>
<dd><p>single logical, specifies whether larger estimates of
the outcome are favourable or not; defaults to <code>FALSE</code>, corresponding to,
e.g., an undesirable binary outcomes (e.g., mortality) or a continuous
outcome where lower numbers are preferred (e.g., hospital length of stay).</p></dd>


<dt>soften_power</dt>
<dd><p>either a single numeric value or a numeric vector of
exactly the same length as the maximum number of looks/adaptive analyses.
Values must be between <code>0</code> and <code>1</code> (default); if <code>&lt; 1</code>, then re-allocated
non-fixed allocation probabilities are all raised to this power to make
allocation probabilities less extreme, in turn used to redistribute
remaining probability while respecting limits when defined by <code>min_probs</code>
and/or <code>max_probs</code>. If <code>1</code>, then no <em>softening</em> is applied.</p></dd>


<dt>fun_raw_est</dt>
<dd><p>function that takes a numeric vector and returns a
single numeric value, used to calculate a raw summary estimate of the
outcomes in each <code>arm</code>. Defaults to <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>, which is always used in the
<code><a href="setup_trial_binom.html">setup_trial_binom()</a></code> and <code><a href="setup_trial_norm.html">setup_trial_norm()</a></code> functions.<br><strong>Note:</strong> the function is called one time per arm during setup to validate
the output structure.</p></dd>


<dt>cri_width</dt>
<dd><p>single numeric <code>&gt;= 0</code> and <code>&lt; 1</code>, the width of the
percentile-based credible intervals used when summarising individual trial
results. Defaults to <code>0.95</code>, corresponding to 95% credible intervals.</p></dd>


<dt>n_draws</dt>
<dd><p>single integer, the number of draws from the posterior
distributions (for each arm) used when running the trial. Defaults to
<code>5000</code>; can be reduced for a speed gain (at the potential loss of stability
of results if too low) or increased for increased precision (takes longer).
Values <code>&lt; 100</code> are not allowed and values <code>&lt; 1000</code> are not recommended
and warned against.</p></dd>


<dt>robust</dt>
<dd><p>single logical, if <code>TRUE</code> (default) the medians and median
absolute deviations (scaled to be comparable to the standard deviation for
normal distributions; MAD_SD) are used to summarise the posterior
distributions; if <code>FALSE</code>, the means and standard deviations (SDs) are used
instead (slightly faster, but may be less appropriate for posteriors skewed
on the natural scale).</p></dd>


<dt>description</dt>
<dd><p>optional single character string describing the trial
design, will only be used in print functions if not <code>NULL</code> (the default).</p></dd>


<dt>add_info</dt>
<dd><p>optional single string containing additional information
regarding the trial design or specifications, will only be used in print
functions if not <code>NULL</code> (the default).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>trial_spec</code> object used to run simulations by <code><a href="run_trial.html">run_trial()</a></code> or
<code><a href="run_trials.html">run_trials()</a></code>. The output is essentially a list containing the input
values (some combined in a <code>data.frame</code> called <code>trial_arms</code>), but its class
signals that these inputs have been validated and inappropriate
combinations and settings have been ruled out. Also contains <code>best_arm</code></p>


<p>holding the arm(s) with the best value(s) in <code>true_ys</code>. Use <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> to
peruse the actual content of the returned object</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><strong>How to specify the <code>fun_y_gen</code> function</strong></p>
<p>The function must take the following inputs:</p><ul><li><p><code>allocs</code>: character vector, the trial <code>arms</code> that new patients allocated
since the last adaptive analysis are randomised to.</p></li>
</ul><p>The function must return a single numeric vector, corresponding to the
outcomes for all patients allocated since the last adaptive analysis, in the
same order as <code>allocs</code>.<br>
See the <strong>Examples</strong> vignette (<code>vignette("Examples", "adaptr")</code>) for an
example with further details.</p>
<p><strong>How to specify the <code>fun_draws</code> function</strong></p>
<p>The function must take the following inputs:</p><ul><li><p><code>arms</code>: character vector, the unique trial arms, in the same order as
above, but only the <strong>currently active</strong> arms are specified when the function is
called.</p></li>
<li><p><code>allocs</code>: a vector of allocations for all patients, corresponding to the
trial arms, including patients allocated to <strong>currently inactive</strong> <code>arms</code> when
called,</p></li>
<li><p><code>ys</code>: a vector of outcomes for all patients in the same order as <code>allocs</code>,
including outcomes for patients allocated to <strong>currently inactive</strong> <code>arms</code>
when called.</p></li>
<li><p><code>control</code>: single character, the current <code>control arm</code>, will be <code>NULL</code> for
designs without a common control arm, but required regardless as the argument
is supplied by <code><a href="run_trial.html">run_trial()</a></code>/<code><a href="run_trials.html">run_trials()</a></code>.</p></li>
<li><p><code>n_draws</code>: single integer, the number of posterior draws for each arm.</p></li>
</ul><p>The function must return a <code>matrix</code> (with numeric values) with <code>arms</code> columns
and <code>n_draws</code> rows. The <code>matrix</code> must have columns
<strong>only for currently active arms</strong> (when called). Each row should contain a
single posterior draw for each arm on the original outcome
scale: if they are estimated as, e.g., the <em>log(odds)</em>, these estimates must
be transformed to probabilities and similarly for other measures.<br>
Important: the <code>matrix</code> cannot contain <code>NA</code>s, even if no patients have been
randomised to an arm yet. See the provided example for one way to alleviate
this.<br>
See the <strong>Examples</strong> vignette (<code>vignette("Examples", "adaptr")</code>) for an
example with further details.</p>
<p><em>Notes</em></p><ul><li><p>Different estimation methods and prior distributions may be used;
complex functions will lead to slower simulations compared to simpler
methods for obtaining posterior draws, including those specified using the
<code><a href="setup_trial_binom.html">setup_trial_binom()</a></code> and <code><a href="setup_trial_norm.html">setup_trial_norm()</a></code> functions.</p></li>
<li><p>Technically, using log relative effect measures — e.g. log(odds ratio) or
log(risk ratios) - or differences compared to a reference arm (e.g., mean
differences or absolute risk differences) instead of absolute values in each
arm will work to some extent (<strong>be cautious!</strong>):</p></li>
<li><p>Stopping for superiority/inferiority/max sample sizes will work.</p></li>
<li><p>Stopping for equivalence/futility may be used with relative effect
measures on the log scale.</p></li>
<li><p>Several summary statistics from <code><a href="run_trial.html">run_trial()</a></code> (<code>sum_ys</code> and posterior
estimates) may be nonsensical if relative effect measures are used
(depending on calculation method).</p></li>
<li><p>In the same vein, <code><a href="extract_results.html">extract_results()</a></code> (<code>sum_ys</code>, <code>sq_err</code>, and
<code>sq_err_te</code>), and <code><a href="summary.html">summary()</a></code> (<code>sum_ys_mean/sd/median/q25/q75</code>, <code>rmse</code>,
<code>rmse_te</code> and <code>idp</code>) may be equally nonsensical when calculated on the
relative scale.</p></li>
</ul><p><strong>Using additional custom or functions from loaded packages in the
custom functions</strong>
If the <code>fun_y_gen</code>, <code>fun_draws</code>, or <code>fun_raw_est</code> functions calls other
user-specified functions (or uses objects defined by the user outside these
functions or the <code>setup_trial()</code>-call) or functions from external packages
and simulations are conducted on multiple cores, these objects or functions must
be exported or prefixed with their namespaces, respectively, as  described in
<code><a href="run_trials.html">run_trials()</a></code>.</p>
<p><strong>More information on arguments</strong></p><ul><li><p><code>control</code>: if one or more treatment arms are superior to the control arm
(i.e., passes the superiority threshold as defined above), this arm will
become the new control (if multiple arms are superior, the one with the
highest probability of being the overall best will become the new control),
the previous control will be dropped for inferiority, and all remaining arms
will be immediately compared to the new control in the same adaptive analysis
and dropped if inferior (or possibly equivalent/futile, see below) compared
to this new control arm. Only applies in trials with a common <code>control</code>.</p></li>
<li><p><code>control_prob_fixed</code>: If the length is 1, then this allocation probability
will be used for the <code>control</code> group (including if a new arm becomes the
control and the original control is dropped). If multiple values are specified
the first value will be used when all arms are active, the second when one
arm has been dropped, and so forth. If 1 or more values are specified,
previously set <code>fixed_probs</code>, <code>min_probs</code> or <code>max_probs</code> for new control arms
will be ignored. If all allocation probabilities do not sum to 1 (e.g, due to
multiple limits) they will be re-scaled to do so.<br>
Can also be set to one of the special arguments <code>"sqrt-based"</code>,
<code>"sqrt-based start"</code>, <code>"sqrt-based fixed"</code> or <code>"match"</code> (written exactly as
one of those, case sensitive). This requires <code>start_probs</code> to be <code>NULL</code> and
relevant <code>fixed_probs</code> to be <code>NULL</code> (or <code>NA</code> for the control arm).<br>
If one of the <code>"sqrt-based"/"sqrt-based start"/"sqrt-based fixed"</code> options
are used, the function will set <em>square-root-transformation-based</em> starting
allocation probabilities. These are defined as:<br><code>square root of number of non-control arms to 1-ratio for other arms</code><br>
scaled to sum to 1, which will generally increase power for comparisons
against the common control, as discussed in, e.g., <em>Park et al, 2020</em>
<a href="https://doi.org/10.1016/j.jclinepi.2020.04.025" class="external-link">doi:10.1016/j.jclinepi.2020.04.025</a>
.<br>
If <code>"sqrt-based"</code>, square-root-transformation-based allocation probabilities
will also be used for new controls when arms are dropped. If
<code>"sqrt-based start"</code>, the control arm will be fixed to this allocation
probability at all times (also after arm dropping, with re-scaling as
necessary, as specified above). If <code>"sqrt-based fixed"</code> is chosen,
square-root-transformation-based allocation probabilities will be used and
all allocation probabilities will be fixed throughout the trial (with
re-scaling when arms are dropped).<br>
If <code>"match"</code> is specified, the control group allocation will always be
<em>matched</em> to be similar to the highest non-control arm allocation ratio.</p></li>
</ul><p><strong>Superiority and inferiority</strong></p>
<p>In trial designs without a common control arm, superiority and inferiority
are assessed by comparing all <em><strong>currently active</strong></em> groups. This means that
if a "final" analysis of a trial without a common control and <code>&gt; 2 arms</code> is
conducted including all arms (as will often be done in practice) <em>after</em> an
adaptive trial have stopped, the final probabilities of the best arm being
superior may differ slightly.<br>
For example, in a trial with three arms and no common <code>control</code> arm, one arm
may be dropped early for inferiority defined as <code>&lt; 1%</code> probability of being
the overall best <code>arm</code>. The trial may then continue with the two remaining
arms, and stopped when one is declared superior to the other defined as
<code>&gt; 99%</code> probability of being the overall best <code>arm</code>. If a final analysis is
then conducted including all arms, the final probability of the best arm
being overall superior will generally be slightly lower as the probability
of the first dropped arm being the best will generally be <code>&gt; 0%</code>, even if
very low and below the inferiority threshold.<br>
This is not relevant trial designs <em>with</em> a common <code>control</code>, as pairwise
assessments of superiority/inferiority compared to the common <code>control</code> will
not be influenced similarly by previously dropped arms (and previously
dropped arms may be included in the analyses, even if posterior distributions
are not returned for those).
Similarly, in actual clinical trials, final probabilities may change slightly
as the most recently randomised patients will generally not have outcome data
available at the final adaptive analysis where the trial is stopped.</p>
<p><strong>Equivalence</strong></p>
<p>Equivalence is assessed <em><strong>after</strong></em> both inferiority and
superiority have been assessed (and in case of superiority, it will be
assessed against the new <code>control</code> arm in designs with a common <code>control</code>, if
specified - see above).</p>
<p><strong>Futility</strong></p>
<p>Futility is assessed <em><strong>after</strong></em> inferiority, superiority, <em><strong>and</strong></em>
equivalence have been assessed (and in case of superiority, it will be
assessed against the new control arm in designs with a common control, if
specified - see above). Arms will thus be dropped for equivalence before
futility.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="co"># Setup a custom trial specification with right-skewed, log-normally</span></span>
<span class="r-in"><span class="co"># distributed continuous outcomes (higher values are worse)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Define the function that will generate the outcomes in each arm</span></span>
<span class="r-in"><span class="co"># Notice: contents should match arms/true_ys in the setup_trial() call below</span></span>
<span class="r-in"><span class="va">get_ys_lognorm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">allocs</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in">  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">allocs</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in">  <span class="co"># arms (names and order) and values (except for exponentiation) should match</span></span>
<span class="r-in">  <span class="co"># those used in setup_trial (below)</span></span>
<span class="r-in">  <span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span> <span class="op">=</span> <span class="fl">2.2</span>, <span class="st">"Experimental A"</span> <span class="op">=</span> <span class="fl">2.1</span>, <span class="st">"Experimental B"</span> <span class="op">=</span> <span class="fl">2.3</span><span class="op">)</span></span>
<span class="r-in">  <span class="kw">for</span> <span class="op">(</span><span class="va">arm</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in">    <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">allocs</span> <span class="op">==</span> <span class="va">arm</span><span class="op">)</span></span>
<span class="r-in">    <span class="va">y</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span>, <span class="va">means</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span>, <span class="fl">1.5</span><span class="op">)</span></span>
<span class="r-in">  <span class="op">}</span></span>
<span class="r-in">  <span class="va">y</span></span>
<span class="r-in"><span class="op">}</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Define the function that will generate posterior draws</span></span>
<span class="r-in"><span class="co"># In this example, the function uses no priors (corresponding to improper</span></span>
<span class="r-in"><span class="co"># flat priors) and calculates results on the log-scale, before exponentiating</span></span>
<span class="r-in"><span class="co"># back to the natural scale, which is required for assessments of</span></span>
<span class="r-in"><span class="co"># equivalence, futility and general interpretation</span></span>
<span class="r-in"><span class="va">get_draws_lognorm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arms</span>, <span class="va">allocs</span>, <span class="va">ys</span>, <span class="va">control</span>, <span class="va">n_draws</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in">  <span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in">  <span class="va">logys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ys</span><span class="op">)</span></span>
<span class="r-in">  <span class="kw">for</span> <span class="op">(</span><span class="va">arm</span> <span class="kw">in</span> <span class="va">arms</span><span class="op">)</span><span class="op">{</span></span>
<span class="r-in">    <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">allocs</span> <span class="op">==</span> <span class="va">arm</span><span class="op">)</span></span>
<span class="r-in">    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span></span>
<span class="r-in">    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in">      <span class="co"># Necessary to avoid errors if too few patients randomised to this arm</span></span>
<span class="r-in">      <span class="va">draws</span><span class="op">[[</span><span class="va">arm</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_draws</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">logys</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">logys</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in">    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span class="r-in">      <span class="co"># Too few patients randomised to this arm - extreme uncertainty</span></span>
<span class="r-in">      <span class="va">draws</span><span class="op">[[</span><span class="va">arm</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_draws</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">logys</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">logys</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">logys</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in">    <span class="op">}</span></span>
<span class="r-in">  <span class="op">}</span></span>
<span class="r-in">  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">draws</span><span class="op">)</span></span>
<span class="r-in"><span class="op">}</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># The actual trial specification is then defined</span></span>
<span class="r-in"><span class="va">lognorm_trial</span> <span class="op">&lt;-</span> <span class="fu">setup_trial</span><span class="op">(</span></span>
<span class="r-in">  <span class="co"># arms should match those above</span></span>
<span class="r-in">  arms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental A"</span>, <span class="st">"Experimental B"</span><span class="op">)</span>,</span>
<span class="r-in">  <span class="co"># true_ys should match those above</span></span>
<span class="r-in">  true_ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.2</span>, <span class="fl">2.1</span>, <span class="fl">2.3</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">  fun_y_gen <span class="op">=</span> <span class="va">get_ys_lognorm</span>, <span class="co"># as specified above</span></span>
<span class="r-in">  fun_draws <span class="op">=</span> <span class="va">get_draws_lognorm</span>, <span class="co"># as specified above</span></span>
<span class="r-in">  max_n <span class="op">=</span> <span class="fl">5000</span>,</span>
<span class="r-in">  look_after_every <span class="op">=</span> <span class="fl">200</span>,</span>
<span class="r-in">  control <span class="op">=</span> <span class="st">"Control"</span>,</span>
<span class="r-in">  <span class="co"># Qquare-root-based, fixed control group allocation ratio</span></span>
<span class="r-in">  <span class="co"># and response-adaptive randomisation for other arms</span></span>
<span class="r-in">  control_prob_fixed <span class="op">=</span> <span class="st">"sqrt-based"</span>,</span>
<span class="r-in">  <span class="co"># Equivalence assessment</span></span>
<span class="r-in">  equivalence_prob <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span class="r-in">  equivalence_diff <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span class="r-in">  equivalence_only_first <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span class="r-in">  highest_is_best <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span class="r-in">  <span class="co"># Summarise raw results by taking the mean on the</span></span>
<span class="r-in">  <span class="co"># log scale and back-transforming</span></span>
<span class="r-in">  fun_raw_est <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> ,</span>
<span class="r-in">  <span class="co"># Summarise posteriors using medians with MAD-SDs,</span></span>
<span class="r-in">  <span class="co"># as distributions will not be normal on the actual scale</span></span>
<span class="r-in">  robust <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span class="r-in">  <span class="co"># Description/additional info used when printing</span></span>
<span class="r-in">  description <span class="op">=</span> <span class="st">"continuous, log-normally distributed outcome"</span>,</span>
<span class="r-in">  add_info <span class="op">=</span> <span class="st">"SD on the log scale for all arms: 1.5"</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Print trial specification with 3 digits for all probabilities</span></span>
<span class="r-in"><span class="fu"><a href="print.html">print</a></span><span class="op">(</span><span class="va">lognorm_trial</span>, prob_digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Trial specification: continuous, log-normally distributed outcome</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Undesirable outcome</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Common control arm: Control </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Control arm probability fixed at 0.414 (for 3 arms), 0.5 (for 2 arms)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Best arm: Experimental A</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Arms, true outcomes, starting allocation probabilities </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> and allocation probability limits:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            arms true_ys start_probs fixed_probs min_probs max_probs</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Control    9.03       0.414       0.414        NA        NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Experimental A    8.17       0.293          NA        NA        NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Experimental B    9.97       0.293          NA        NA        NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Maximum sample size: 5000 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Maximum number of data looks: 25</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Planned looks after every 200 patients until maximum sample size</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Superiority threshold: 0.99 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Inferiority threshold: 0.01 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Equivalence threshold: 0.9 (only checked for first control)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Absolute equivalence difference: 0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> No futility threshold</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Soften power for all analyses: 1 (no softening)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Additional info: SD on the log scale for all arms: 1.5</span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Anders Granholm, Benjamin Skov Kaas-Hansen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.4.</p>
</div>

    </footer></div>

  

  

  </body></html>

