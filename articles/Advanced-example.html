<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="adaptr">
<title>Advanced example • adaptr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced example">
<meta property="og:description" content="adaptr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">adaptr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Advanced-example.html">Advanced example</a>
    <a class="dropdown-item" href="../articles/Basic-examples.html">Basic examples</a>
    <a class="dropdown-item" href="../articles/Overview.html">Overview</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/INCEPTdk/adaptr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/INCEPTdk/adaptr/blob/HEAD/vignettes/Advanced-example.Rmd" class="external-link"><code>vignettes/Advanced-example.Rmd</code></a></small>
      <div class="d-none name"><code>Advanced-example.Rmd</code></div>
    </div>

    
    
<p>This vignette provides an <strong>advanced</strong> example on how
to:</p>
<ol style="list-style-type: decimal">
<li>Specify a trial design with <code><a href="../reference/setup_trial.html">setup_trial()</a></code> using
user-written functions for generating outcomes and drawing samples from
the posterior distributions</li>
<li>Transform the raw outcome estimates in a way appropriate for your
needs</li>
<li>Derive and specify prior probability distributions</li>
</ol>
<p>The manual for <code><a href="../reference/setup_trial.html">setup_trial()</a></code> contains another example
(more succinctly annotated); see the <strong>Examples</strong> sections
in <code>?setup_trial()</code>. As an alternative to using custom
functions, the convenience functions <code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code>
and <code><a href="../reference/setup_trial_norm.html">setup_trial_norm()</a></code> may be used for simulating trials
with binary, binomially distributed or continuous, normally distributed
outcomes, using sensible defaults and flat priors.</p>
<p>This vignette is intended for advanced users and assume general
knowledge of writing R functions and specifying prior distributions for
(simple, conjugate) Bayesian models. Before reading this vignette, we
highly encourage you to read the Basic examples vignette (see
<code><a href="../articles/Basic-examples.html">vignette("Basic-examples", "adaptr")</a></code>) with more basic
examples using the simplified <code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code> function
and a thorough discussion of the settings applicable to all trial
designs.</p>
<div class="section level2">
<h2 id="preamble">Preamble<a class="anchor" aria-label="anchor" href="#preamble"></a>
</h2>
<p>In this example, we set up a trial with three <code>arms</code>, one
of which is the <code>control</code>, and an undesirable binary outcome
(e.g., mortality).</p>
<p>This examples creates a custom version of the
<code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code> function using non-flat priors for the
event rates in each arm (<code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code> uses flat
priors), and returning event probabilities as percentages (instead of
fractions), to illustrate the use of a custom function to summarise the
raw outcome data.</p>
<p>While <code><a href="../reference/setup_trial.html">setup_trial()</a></code> attempts to validate the custom
functions by assessing their output during trial specification, some
edge cases might elude this validation. We, therefore, urge users
specifying custom functions to carefully test more complex functions
themselves before actual use.</p>
<p>If you go through the trouble of writing a nice set of functions for
generating outcomes and sampling from posterior distributions, please
consider adding these to the package. This way, others can benefit from
your work and it helps validate them. See how on the <a href="https://github.com/INCEPTdk/adaptr#contributing" class="external-link">GitHub</a> page
under <strong>Contributing</strong>.</p>
<p>Although the user-written custom functions below do not depend on the
<code>adaptr</code> package, as the first thing we load the package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://incept.dk/" class="external-link">adaptr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading adaptr package (version 1.2.0).</span></span>
<span><span class="co">#&gt; See 'help("adaptr")' or 'vignette("Overview", "adaptr")' for help.</span></span>
<span><span class="co">#&gt; Further information available on https://inceptdk.github.io/adaptr/.</span></span></code></pre></div>
<p>–and then set the global seed to ensure reproducible results:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">89</span><span class="op">)</span></span></code></pre></div>
<p>We define the functions and (for illustration purposes and as a
sanity check) print their outputs. They are, then, invoked by
<code><a href="../reference/setup_trial.html">setup_trial()</a></code> (in the final code chunk of this
vignette).</p>
</div>
<div class="section level2">
<h2 id="functions-for-generating-outcomes">Functions for generating outcomes<a class="anchor" aria-label="anchor" href="#functions-for-generating-outcomes"></a>
</h2>
<p>This function should take a single argument (<code>allocs</code>), a
character vector containing the allocations (names of trial
<code>arms</code>) of all patients included since the last adaptive
analysis. The function must return a <em>numeric</em> vector, regardless
of actual outcome type (so, e.g., categorical outcomes must be encoded
as numeric). The returned numeric vector must be of the same length, and
the values in the same order as <code>allocs</code>. That is, the third
element of <code>allocs</code> specifies the allocation of the third
patient randomised since the last adaptive analysis, and
(correspondingly) the third element of the returned vector is that
patient’s outcome.</p>
<p>It sounds complicated, but it becomes clearer when we actually
specify the function (essentially a re-implementation of the built-in
function used by <code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code>):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_ys_binom_custom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">allocs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Binary outcome coded as 0/1 - prepare returned vector of appropriate length</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">allocs</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Specify trial arms and true event probabilities for each arm</span></span>
<span>  <span class="co"># These values should exactly match those supplied to setup_trial</span></span>
<span>  <span class="co"># NB! This is not validated, so this is the user's responsibility</span></span>
<span>  <span class="va">arms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental arm A"</span>, <span class="st">"Experimental arm B"</span><span class="op">)</span></span>
<span>  <span class="va">true_ys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.27</span>, <span class="fl">0.20</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Loop through arms and generate outcomes</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">arms</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Indices of patients allocated to the current arm</span></span>
<span>    <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">allocs</span> <span class="op">==</span> <span class="va">arms</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># Generate outcomes for all patients allocated to current arm</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">true_ys</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return outcome vector</span></span>
<span>  <span class="va">y</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To illustrate how the function works, we first generate random
allocations for 50 patients using equal allocation probabilities, the
default behaviour of <code><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample()</a></code>. By enclosing the call in
parentheses, the resulting allocations are printed:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">allocs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental arm A"</span>, <span class="st">"Experimental arm  B"</span><span class="op">)</span>,</span>
<span>                  size <span class="op">=</span> <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Control"             "Experimental arm  B" "Experimental arm  B"</span></span>
<span><span class="co">#&gt;  [4] "Experimental arm  B" "Experimental arm  B" "Experimental arm A" </span></span>
<span><span class="co">#&gt;  [7] "Experimental arm A"  "Experimental arm A"  "Experimental arm A" </span></span>
<span><span class="co">#&gt; [10] "Experimental arm A"  "Experimental arm  B" "Experimental arm  B"</span></span>
<span><span class="co">#&gt; [13] "Experimental arm  B" "Control"             "Experimental arm  B"</span></span>
<span><span class="co">#&gt; [16] "Control"             "Experimental arm A"  "Experimental arm A" </span></span>
<span><span class="co">#&gt; [19] "Experimental arm A"  "Experimental arm  B" "Control"            </span></span>
<span><span class="co">#&gt; [22] "Control"             "Experimental arm  B" "Control"            </span></span>
<span><span class="co">#&gt; [25] "Experimental arm A"  "Control"             "Experimental arm A" </span></span>
<span><span class="co">#&gt; [28] "Control"             "Experimental arm  B" "Experimental arm  B"</span></span>
<span><span class="co">#&gt; [31] "Control"             "Experimental arm  B" "Control"            </span></span>
<span><span class="co">#&gt; [34] "Control"             "Experimental arm A"  "Experimental arm  B"</span></span>
<span><span class="co">#&gt; [37] "Control"             "Experimental arm A"  "Experimental arm A" </span></span>
<span><span class="co">#&gt; [40] "Experimental arm A"  "Experimental arm  B" "Experimental arm A" </span></span>
<span><span class="co">#&gt; [43] "Control"             "Experimental arm  B" "Control"            </span></span>
<span><span class="co">#&gt; [46] "Control"             "Control"             "Control"            </span></span>
<span><span class="co">#&gt; [49] "Experimental arm A"  "Experimental arm A"</span></span></code></pre></div>
<p>Next, we generate random outcomes for these patients:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">ys</span> <span class="op">&lt;-</span> <span class="fu">get_ys_binom_custom</span><span class="op">(</span><span class="va">allocs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 1 0 0 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; [39] 0 0 0 1 1 0 0 1 0 1 1 0</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="functions-for-drawing-posterior-samples">Functions for drawing posterior samples<a class="anchor" aria-label="anchor" href="#functions-for-drawing-posterior-samples"></a>
</h2>
<p>The <code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code> function uses <em>beta-binomial
conjugate prior models</em> in each arm, with <code>beta(1, 1)</code>
priors. These priors are uniform (≈ “non-informative”) on the
probability scale and corresponds to the same amount of information as
provided by 2 patients (1 with and 1 without an event), described in
greater detail by, e.g., <em>Ryan et al, 2019</em> (<a href="https://doi.org/10.1136/bmjopen-2018-024256" class="external-link">10.1136/bmjopen-2018-024256</a>).</p>
<p>Our custom function for generating posterior draws also uses
beta-binomial conjugate prior models, but with informative priors.
Informative priors may prevent undue influence of random, early
fluctuations in a trial by pulling posterior estimates closer to the
prior when limited data are available.</p>
<p>We seek relatively weakly informative priors centred on previous
knowledge (or beliefs), and so before we can actually define a function
for generating posterior draws based on informative priors, we need to
derive such a prior.</p>
<div class="section level3">
<h3 id="informative-priors">Informative priors<a class="anchor" aria-label="anchor" href="#informative-priors"></a>
</h3>
<p>We assume that we have prior knowledge corresponding to a belief that
the best estimate for the true event probability in the
<code>control</code> arm is 0.25 (25%), and that the true event
probability is between 0.15 and 0.35 (15-35%) with 95% probability. The
mean of a beta distribution is simply
<code>[number of events]/[number of patients]</code>.</p>
<p>To derive a beta distribution that reflects this prior belief, we use
<code><a href="../reference/find_beta_params.html">find_beta_params()</a></code>, a helper function included in the
<code>adaptr</code> (see <code><a href="../reference/find_beta_params.html">?find_beta_params</a></code> for
details):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/find_beta_params.html">find_beta_params</a></span><span class="op">(</span></span>
<span>  theta <span class="op">=</span> <span class="fl">0.25</span>, <span class="co"># Event ratio</span></span>
<span>  boundary <span class="op">=</span> <span class="st">"lower"</span>,</span>
<span>  boundary_target <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  interval_width <span class="op">=</span> <span class="fl">0.95</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   alpha beta      p2.5     p50.0     p97.5</span></span>
<span><span class="co">#&gt; 1    15   45 0.1498208 0.2472077 0.3659499</span></span></code></pre></div>
<p>We thus see that our prior belief prior roughly corresponds to
previous randomisation of 60 patients of whom 15 (<code>alpha</code>)
experienced the event and 45 (<code>beta</code>) did not.</p>
<p>Even though we may expect event probabilities to differ in the
non-control arms, for this example we consider this prior appropriate
for all arms as we consider event probabilities smaller/larger than
those represented by the prior unlikely.</p>
<p>Below, we illustrate the effects of this prior compared to the
default <code>beta(1, 1)</code> prior used in
<code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code> for a single trial arm with 20 patients
randomised, 12 events and 8 non-events. This corresponds to an estimated
event probability of 0.6 (60%), far more than the expected 0.25 (25%).
This could come about by random fluctuations when few patients have been
randomised, even if our prior beliefs are correct.</p>
<p><img src="Advanced-example_files/figure-html/prior_posterior_20-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Next, we illustrate the effects on the same prior after 200 patients
have been randomised to the same arm, with 56 events and 144 non-events,
which corresponds to an estimated event probability of 0.28 (28%), which
is more similar to the expected event probability.</p>
<p><img src="Advanced-example_files/figure-html/prior_posterior_200-1.png" width="576" style="display: block; margin: auto;"></p>
<p>When comparing to the previous plot, we clearly see that once more
patients have been randomised, the larger sample of observed data starts
to dominate the posterior, so that the prior exerts less influence on
the posterior distribution (both posterior distributions are very alike
despite the very different prior distributions).</p>
</div>
<div class="section level3">
<h3 id="defining-the-function-to-generate-posterior-draws">Defining the function to generate posterior draws<a class="anchor" aria-label="anchor" href="#defining-the-function-to-generate-posterior-draws"></a>
</h3>
<p>There are a number of important things to be aware of when specifying
this function. First, it must accept all the following arguments (with
the exact same names, <em>even</em> if you do not used them in your
function):</p>
<ul>
<li>
<code>arms</code>: character vector of the <em>currently active</em>
<code>arms</code> in the trial.</li>
<li>
<code>allocs</code>: character vector of the allocations (trial
<code>arms</code>) of <em>all</em> patients randomised in the trial,
<em>including</em> those randomised to <code>arms</code> that are no
longer active.</li>
<li>
<code>ys</code>: numeric vector of the outcomes of <em>all</em>
patients randomised in the trial, <em>including</em> those randomised to
<code>arms</code> that are no longer active.</li>
<li>
<code>control</code>: single character, the <em>current</em>
<code>control</code> arm; <code>NULL</code> in trials without a common
<code>control</code>.</li>
<li>
<code>n_draws</code>: single integer, the number of posterior draws
to generate for <em>each</em> arm.</li>
</ul>
<p>Alternatively, unused arguments can be left out and the ellipsis
(<code>...</code>) included as the final argument in your function.</p>
<p>Second, the order of <code>allocs</code> and <code>ys</code> must
match: the fifth element of <code>allocs</code> represents the
allocation of the fifth patient, while the fifth element of
<code>ys</code> represent the outcome of the same patient.</p>
<p>Third, <code>allocs</code> and <code>ys</code> are provided for
<strong>all</strong> patients, including those randomised to
<code>arms</code> that are no longer active. This is done as users in
some situations may want to use these data when generating posterior
draws for the other (and currently <strong>active</strong>)
<code>arms</code>.</p>
<p>Fourth, <code>adaptr</code> does not restrict how posterior samples
are drawn. Consequently, Markov chain Monte Carlo- or variational
inference-based methods may be used, and other packages supplying such
functionality may be called by user-provided functions. However, using
more complex methods than simple conjugate models substantially
increases simulation run time. Consequently, simpler models are
well-suited for use in simulations.</p>
<p>Fifth, the function must return a numeric <code>matrix</code> with
<code>length(arms)</code> columns and <code>n_draws</code> rows, with
the <strong>currently active</strong> <code>arms</code> as column names.
That is, each row must contain one posterior draw for each arm.
<code>NA</code>’s are not allowed, so even if no patients have been
randomised to an arm yet, valid numeric values should be returned (e.g.,
drawn from the prior or from another very diffuse <em>posterior</em>
distribution). Even if the outcome is not truly numeric, both the vector
of outcomes provided to the function (<code>ys</code>) and the returned
<code>matrix</code> with posterior draws must be encoded as numeric.</p>
<p>With this in mind, we are ready to specify the function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_draws_binom_custom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arms</span>, <span class="va">allocs</span>, <span class="va">ys</span>, <span class="va">control</span>, <span class="va">n_draws</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Setup a list to store the posterior draws for each arm</span></span>
<span>  <span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Loop through the ACTIVE arms and generate posterior draws</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="va">arms</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Indices of patients allocated to the current arm</span></span>
<span>    <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">allocs</span> <span class="op">==</span> <span class="va">a</span><span class="op">)</span></span>
<span>    <span class="co"># Sum the number of events in the current arm</span></span>
<span>    <span class="va">n_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ys</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># Compute the number of patients in the current arm</span></span>
<span>    <span class="va">n_patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span></span>
<span>    <span class="co"># Generate draws using the number of events, the number of patients</span></span>
<span>    <span class="co"># and the prior specified above: beta(15, 45)</span></span>
<span>    <span class="co"># Saved using the current arms' name in the list, ensuring that the</span></span>
<span>    <span class="co"># resulting matrix has column names corresponding to the ACTIVE arms</span></span>
<span>    <span class="va">draws</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_draws</span>, <span class="fl">15</span> <span class="op">+</span> <span class="va">n_events</span>, <span class="fl">45</span> <span class="op">+</span> <span class="va">n_patients</span> <span class="op">-</span> <span class="va">n_events</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Bind all elements of the list column-wise to form a matrix with</span></span>
<span>  <span class="co"># 1 named column per ACTIVE arm and 1 row per posterior draw.</span></span>
<span>  <span class="co"># Multiply result with 100, as we're using percentages and not proportions</span></span>
<span>  <span class="co"># in this example (just to correspond to the illustrated custom function to</span></span>
<span>  <span class="co"># generate RAW outcome estimates below)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">draws</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We now call the function using the previously generated
<code>allocs</code> and <code>ys</code>.</p>
<p>To avoid cluttering, we only generate 10 posterior draws from each
arm in this example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_draws_binom_custom</span><span class="op">(</span></span>
<span>  <span class="co"># Only currently ACTIVE arms, but all are considered active at this time</span></span>
<span>  arms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental arm A"</span>, <span class="st">"Experimental arm B"</span><span class="op">)</span>,</span>
<span>  allocs <span class="op">=</span> <span class="va">allocs</span>, <span class="co"># Generated above</span></span>
<span>  ys <span class="op">=</span> <span class="va">ys</span>, <span class="co"># Generated above</span></span>
<span>  <span class="co"># Input control arm, argument is supplied even if not used in the function</span></span>
<span>  control <span class="op">=</span> <span class="st">"Control"</span>,</span>
<span>  <span class="co"># Input number of draws (for brevity, only 10 draws here)</span></span>
<span>  n_draws <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;        Control Experimental arm A Experimental arm B</span></span>
<span><span class="co">#&gt;  [1,] 30.96555           29.34973           29.26143</span></span>
<span><span class="co">#&gt;  [2,] 30.47382           23.22668           25.08249</span></span>
<span><span class="co">#&gt;  [3,] 31.04807           31.76577           19.81416</span></span>
<span><span class="co">#&gt;  [4,] 17.00712           24.30809           16.36256</span></span>
<span><span class="co">#&gt;  [5,] 21.31251           27.74615           22.63147</span></span>
<span><span class="co">#&gt;  [6,] 25.50944           24.16283           30.29049</span></span>
<span><span class="co">#&gt;  [7,] 16.60420           29.49526           28.75436</span></span>
<span><span class="co">#&gt;  [8,] 25.17899           33.29374           30.87149</span></span>
<span><span class="co">#&gt;  [9,] 23.72043           27.78537           29.89836</span></span>
<span><span class="co">#&gt; [10,] 30.50004           28.43694           26.62115</span></span></code></pre></div>
<p><strong>Importantly</strong>, less than 100 posterior draws from each
arm is not allowed when setting up the trial specification, to avoid
unstable results (see <code><a href="../reference/setup_trial_binom.html">setup_trial_binom()</a></code>).</p>
</div>
</div>
<div class="section level2">
<h2 id="specifying-the-function-to-calculate-raw-outcome-estimates">Specifying the function to calculate raw outcome estimates<a class="anchor" aria-label="anchor" href="#specifying-the-function-to-calculate-raw-outcome-estimates"></a>
</h2>
<p>Finally, a custom function may be specified to calculate
<strong>raw</strong> summary estimates in each arm; these raw estimates
are <em>not</em> posterior estimates, but can be considered the maximum
likelihood point estimates in this example. This function must take a
numeric vector (all outcomes in an arm) and return a single numeric
value. This function is called separately for each arm. Because we
express results as <em>percentages</em> and not <em>proportions</em> in
this example, this function simply calculates the outcome percentage in
each arm:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fun_raw_est_custom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ys</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We now call this function on the outcomes in the
<code>"Control"</code> arm, as an example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>  <span class="st">"Raw outcome percentage estimate in the 'Control' group: %.1f%%"</span>, </span>
<span>  <span class="fu">fun_raw_est_custom</span><span class="op">(</span><span class="va">ys</span><span class="op">[</span><span class="va">allocs</span> <span class="op">==</span> <span class="st">"Control"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Raw outcome percentage estimate in the 'Control' group: 29.4%</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup-the-trial-specification">Setup the trial specification<a class="anchor" aria-label="anchor" href="#setup-the-trial-specification"></a>
</h2>
<p>With all the functions defined, we can now setup the trial
specification - as stated above, some validation of all the custom
functions is carried out when the trial is setup:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_trial.html">setup_trial</a></span><span class="op">(</span></span>
<span>  arms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental arm A"</span>, <span class="st">"Experimental arm B"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># true_ys, true outcome percentages (since posterior draws and raw estimates</span></span>
<span>  <span class="co"># are returned as percentages, this must be a percentage as well, even if</span></span>
<span>  <span class="co"># probabilities are specified as proportions internally in the outcome</span></span>
<span>  <span class="co"># generating function specified above</span></span>
<span>  true_ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">27</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Supply the functions to generate outcomes and posterior draws</span></span>
<span>  fun_y_gen <span class="op">=</span> <span class="va">get_ys_binom_custom</span>,</span>
<span>  fun_draws <span class="op">=</span> <span class="va">get_draws_binom_custom</span>,</span>
<span>  </span>
<span>  <span class="co"># Define looks</span></span>
<span>  max_n <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  look_after_every <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  </span>
<span>  <span class="co"># Define control and allocation strategy</span></span>
<span>  control <span class="op">=</span> <span class="st">"Control"</span>,</span>
<span>  control_prob_fixed <span class="op">=</span> <span class="st">"sqrt-based"</span>,</span>
<span>  </span>
<span>  <span class="co"># Define equivalence assessment - drop non-control arms at &gt; 90% probability</span></span>
<span>  <span class="co"># of equivalence, defined as an absolute difference of 10 %-points</span></span>
<span>  <span class="co"># (specified on the percentage-point scale as the rest of probabilities in</span></span>
<span>  <span class="co"># the example)</span></span>
<span>  equivalence_prob <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>  equivalence_diff <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  equivalence_only_first <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  </span>
<span>  <span class="co"># Input the function used to calculate raw outcome estimates</span></span>
<span>  fun_raw_est <span class="op">=</span> <span class="va">fun_raw_est_custom</span>,</span>
<span>  </span>
<span>  <span class="co"># Description and additional information</span></span>
<span>  description <span class="op">=</span> <span class="st">"custom trial [binary outcome, weak priors]"</span>,</span>
<span>  add_info <span class="op">=</span> <span class="st">"Trial using beta-binomial conjugate prior models and beta(15, 45) priors in each arm."</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Trial specification: custom trial [binary outcome, weak priors]</span></span>
<span><span class="co">#&gt; * Undesirable outcome</span></span>
<span><span class="co">#&gt; * Common control arm: Control </span></span>
<span><span class="co">#&gt; * Control arm probability fixed at 0.414 (for 3 arms), 0.5 (for 2 arms)</span></span>
<span><span class="co">#&gt; * Best arm: Experimental arm B</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Arms, true outcomes, starting allocation probabilities </span></span>
<span><span class="co">#&gt; and allocation probability limits:</span></span>
<span><span class="co">#&gt;                arms true_ys start_probs fixed_probs min_probs max_probs</span></span>
<span><span class="co">#&gt;             Control      25       0.414       0.414        NA        NA</span></span>
<span><span class="co">#&gt;  Experimental arm A      27       0.293          NA        NA        NA</span></span>
<span><span class="co">#&gt;  Experimental arm B      20       0.293          NA        NA        NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Maximum sample size: 2000 </span></span>
<span><span class="co">#&gt; Maximum number of data looks: 20</span></span>
<span><span class="co">#&gt; Planned looks after every 100</span></span>
<span><span class="co">#&gt;  patients have reached follow-up until final look after 2000 patients</span></span>
<span><span class="co">#&gt; Number of patients randomised at each look:  100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Superiority threshold: 0.99 (all analyses)</span></span>
<span><span class="co">#&gt; Inferiority threshold: 0.01 (all analyses)</span></span>
<span><span class="co">#&gt; Equivalence threshold: 0.9 (all analyses) (only checked for first control)</span></span>
<span><span class="co">#&gt; Absolute equivalence difference: 10</span></span>
<span><span class="co">#&gt; No futility threshold</span></span>
<span><span class="co">#&gt; Soften power for all analyses: 1 (no softening)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Additional info: Trial using beta-binomial conjugate prior models and beta(15, 45) priors in each arm.</span></span></code></pre></div>
<p>As <code><a href="../reference/setup_trial.html">setup_trial()</a></code> runs with no errors or warnings, the
custom trial has been successfully specified and may be run by
<code><a href="../reference/run_trial.html">run_trial()</a></code> or <code><a href="../reference/run_trials.html">run_trials()</a></code>. If the custom
functions provided to <code><a href="../reference/setup_trial.html">setup_trial()</a></code> calls other custom
functions (or uses objects defined by the user outside these functions)
or if functions loaded from non-base R packages are used, please be
aware that exporting these objects/functions or prefixing them with
their namespace is necessary if simulations are conducted using multiple
cores. See <code><a href="../reference/run_trial.html">run_trial()</a></code> for additional details.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Anders Granholm, Benjamin Skov Kaas-Hansen.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
